# short-url
---
 ## 1. 算法原理分析
---
1. 什么是短网址  
    即将较长的普通请求链接转换为较短的请求链接.  
    如(新浪短网址服务生成):  
       原地址:https://cn.bing.com/search?q=%e7%9f%ad%e7%bd%91%e5%9d%80%e6%9c%8d%e5%8a%a1&qs=HS&pq=%e7%9f%ad%e7%bd%91%e5%9d%80&sc=8-3&cvid=3649594CAEA64898B971A15290DB0B01&FORM=QBRE&sp=1  
       处理后:http://t.cn/RgRjigS  

2. 优点  
    简短、美观、利于传播等，同时浏览器对请求的长度是有限制的.  
    
3. 请求原理  
    (1) DNS服务器通过请求解析到 http://t.cn 后,并获得其对应 IP .  
    (2) DNS服务器获得 IP 后,想该服务器发送 GET 请求查询 RgRjigS 短码对应的原 URL .  
    (3) http://t.cn 通过 RgRjigS 查询对应原 URL, 通过重定向到原请求地址.这里可通过 301 或 302 重定向.  
   
4. 算法分析  
    (1) 32位 md5 随机串 : 将原 url + 随机 key(避免 url 单独 md5 碰撞) , 生成 32 位 md5 随机串 .  
    (2) 32位 md5 随机串均分四段 : 将 md5 随机串均分四段.(生成 4 组 6 位长的短码, 避免碰撞) .   
    (3) 截取段转为 Long : 将对应截取段作为 16 进制数字处理 , 并转换为 Long .  
    (4) Long 转换为有效位 : Long 二进制有效长度为 32 位 , 需要将前面两位去掉 , 留下30位 （30位才能转换62进制 , 否则超出）, 通过 & 0x3fffffff 进行位与运算.  
    (5) 转换 62 进制 : 与 0x0000003D 进行 6 次位运算，每次位移 >> 5 , 通过 & 0x0000003D 进行位与运算得到一个 <= 61 的数字 , 作为数组[a-zA-Z0-9]的下标 , 转换为相应短码.  
    (6) 获取短码 : 从字典([a-zA-Z0-9])中随机获取一个短码 .  
    (7) 重复操作 3 - 6 , 生成 4 组短码 , 并随机选取其中一组 .   
    
    由于需要快速定位 url 是否在数据库已经存在 , 通过 SHA1 算法得到 hash 码存入数据库 , 并作为 uuid 每次压缩操作时 , 通过 hash 码查询确认是否存在 , 存在  
    则返回已有短码 , 否则从新生成对应码 . 
    
---
 ## 2. 设计与实现
---  

1. 表结构设计  (详细见/resources/sql目录sql文件 , 此次仅做关键字段设计说明)
    (1) 短码对应表 table name - short_url    
        a. short_key : 短码(系统默认 6 位) , 数据库索引为唯一索引 , 避免重复短码 , 同时提升查询效率 .  
        b. hash_key : url 对应hash码 , 数据库索引为唯一索引 , 通过 SHA1 算法生成 hash 码 , 提升插入重复情况的排查 . 
        
    短码对应表通过 short_key 及 hash_key , 唯一锁定一个长链接请求 , 通过唯一索引提升查询速度 .  
        
    (2) 短码访问统计表 table name - short_url_visit_record    
        a. short_key : 短码 , 数据库索引普通索引 , 提升查询效率 .  
        b. visit_time : 访问时间 .  
        c. ip : 客户端 ip .  
        d: browser : 客户端浏览信息 .  
        e: device : 客户端系统信息 .  
        f: first_visit_flag : 首次访问表示 , 1 - 首次 , 0 - 非首次 .  
        
     以上通过请求可直接获取客户端信息 , 先阶段提供以上信息统计 . 
     
2. 技术选型  
    Java : Spring Boot + Spring Data    
    SQL : Mysql + Druid  
    View :  Thymeleaf + Vue + LayUi + Echarts + Axios  
    
3. 功能设计  
    (1) 页面包含两部分功能模块 , 压缩 + 统计 .  
    (2) 压缩 :  
        a. 支持用户通过输入 url 直接生成带短码的测试短链接 .  
        b. 支持用户通过输入 url 并自定义短码(非 _ 开头或结尾的字母、数字、下划线组合 , 任意长度) .  
    (3) 统计 : 统计部分包含一个线性统计报表及两个饼状报表 , 提供访问时间范围及短码的条件统计 .   
        a. 线性 : 提供访问总数、IP总数、短码总数的曲线走势 .    
        b. 饼图 : 提供系统类型占比(含总数)、浏览器占比(含总数) . 

---
 ## 3. 运行
---       
1. 运行环境(请确保以下条件具备)  
    Java 安装  
    Maven 安装  
    Mysql 安装     

2. 数据库  
    在确认本地或其它环境数据库可访问的情况下 , 创建数据库 short_url_server , 通过运行 /resources/sql目录下sql文件创建表结构 ,   
    或直接运行项目后面介绍 .  
    
3. 运行   
    (1) 通过 IDEA 运行  
        IDEA中配置 Java + Maven , 导入项目 , 通过直接运行 ShortUrlApplication 启动项目 .  
        
    (2) 通过 MAVEN 运行  
        进入项目根目录 , 进入命令行工具 , 建议通过 GitBash 进行后续操作 , 输入 mvn spring-boot:run 运行项目 .  
        
    (3) 浏览器访问  
        打开浏览器 , 地址栏输入 localhost:8090/index 进入首页  
        
---
 ## 4. 补充 后续添加
---      
1. 长度配置、字典配置  
2. redis 缓存集成  
3. 测试 case                      
        
        
    
    
